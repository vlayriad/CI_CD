#name: ci/cd
#
#on:
#  push:
#    branches:
#      - main
#
#jobs:
#  build:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout Repository
#        uses: actions/checkout@v4
#
#      - name: Install Makefile
#        run: sudo apt install make -y
#
#      - name: Generate Environment File
#        run: make env
#
#      - name: Login to DockerHub
#        uses: docker/login-action@v3
#        with:
#          username: ${{ secrets.DOCKERHUB_USERNAME }}
#          password: ${{ secrets.DOCKERHUB_TOKEN }}
#
#      - name: Set up Docker Buildx
#        uses: docker/setup-buildx-action@v3
#
#      - name: Build and Push Docker Image
#        uses: docker/build-push-action@v6
#        with:
#          context: .
#          platforms: linux/amd64,linux/arm64
#          push: true
#          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:latest
#
#  deploy:
#    runs-on: ubuntu-latest
#    needs: build
#    steps:
#      - name: Deploy to VPS
#        uses: appleboy/ssh-action@v1.2.3
#        with:
#          host: ${{ secrets.SERVER_HOST }}
#          username: ${{ secrets.SERVER_USER }}
#          key: ${{ secrets.SERVER_SSH_KEY }}
#          port: ${{ secrets.SERVER_SSH_PORT }}
#          script: |
#            echo "Pull latest image and restart container..."
#            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:latest
#            docker stop app_container || true
#            docker rm app_container || true
#            docker run -d --name app_container -p ${{ secrets.APP_EXTERNAL_PORT }}:${{ secrets.APP_INTERNAL_PORT }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:latest

name: CI/CD Docker Compose

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y make jq

      - name: Generate config.json from secret
        run: echo "${{ secrets.ENV_CONF }}" > config.json

      - name: Generate docker-compose.yml from secret
        run: echo "${{ secrets.DOCKER_COMPOSE }}" > docker-compose.yml

      - name: Generate Environment File (optional)
        run: make env

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set lowercase repo name
        run: echo "REPO_NAME_LOWER=$(echo '${{ github.event.repository.name }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.REPO_NAME_LOWER }}:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            echo "ğŸ“ Ensure project folder exists"
            if [ ! -d "${{ secrets.SERVER_PROJECT_PATH }}" ]; then
              mkdir -p ${{ secrets.SERVER_PROJECT_PATH }}
            fi
            cd ${{ secrets.SERVER_PROJECT_PATH }}

            echo "ğŸ“¦ Pull latest code"
            if [ -d ".git" ]; then
              git reset --hard
              git clean -fd
              git pull origin main
            else
              git clone git@github.com:${{ github.repository }} .
            fi

            echo "ğŸ§¹ Ensure .env exists"
            if [ ! -f ".env" ]; then
              make env
            fi

            echo "â¬‡ï¸ Docker images before pull"
            sudo docker images

            echo "ğŸš€ Pulling latest image"
            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/$REPO_NAME_LOWER:latest

            echo "â¬‡ï¸ Docker images after pull"
            sudo docker images

            echo "ğŸ›‘ Stop old container"
            sudo docker stop app_container || true
            sudo docker rm app_container || true

            echo "ğŸš€ Start new container using Docker Compose"
            sudo make down
            sudo make pull
            sudo make build

            echo "ğŸ“¦ Running containers"
            sudo docker ps -a

            echo "ğŸ“œ Tail logs (optional)"
            sudo docker compose logs -f
