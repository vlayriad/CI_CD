#name: ci/cd
#
#on:
#  push:
#    branches:
#      - main
#
#jobs:
#  build:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout Repository
#        uses: actions/checkout@v4
#
#      - name: Install Makefile
#        run: sudo apt install make -y
#
#      - name: Generate Environment File
#        run: make env
#
#      - name: Login to DockerHub
#        uses: docker/login-action@v3
#        with:
#          username: ${{ secrets.DOCKERHUB_USERNAME }}
#          password: ${{ secrets.DOCKERHUB_TOKEN }}
#
#      - name: Set up Docker Buildx
#        uses: docker/setup-buildx-action@v3
#
#      - name: Build and Push Docker Image
#        uses: docker/build-push-action@v6
#        with:
#          context: .
#          platforms: linux/amd64,linux/arm64
#          push: true
#          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:latest
#
#  deploy:
#    runs-on: ubuntu-latest
#    needs: build
#    steps:
#      - name: Deploy to VPS
#        uses: appleboy/ssh-action@v1.2.3
#        with:
#          host: ${{ secrets.SERVER_HOST }}
#          username: ${{ secrets.SERVER_USER }}
#          key: ${{ secrets.SERVER_SSH_KEY }}
#          port: ${{ secrets.SERVER_SSH_PORT }}
#          script: |
#            echo "Pull latest image and restart container..."
#            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:latest
#            docker stop app_container || true
#            docker rm app_container || true
#            docker run -d --name app_container -p ${{ secrets.APP_EXTERNAL_PORT }}:${{ secrets.APP_INTERNAL_PORT }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:latest

name: CI/CD Docker Compose

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y make jq

      - name: Generate config.json from secret
        run: echo "${{ secrets.ENV_CONF }}" > config.json

      - name: Generate docker-compose.yml from secret
        run: echo "${{ secrets.DOCKER_COMPOSE }}" > docker-compose.yml

      - name: Generate Environment File (optional)
        run: make env

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set lowercase repo name
        run: echo "REPO_NAME_LOWER=$(echo '${{ github.event.repository.name }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.REPO_NAME_LOWER }}:latest

deploy:
  runs-on: ubuntu-latest
  needs: build

  steps:
    - name: Deploy to VPS via SSH
      uses: appleboy/ssh-action@v1.2.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_SSH_PORT }}
        script: |
          # Kirim variabel REPO_NAME_LOWER ke VPS
          REPO_NAME_LOWER=${{ github.event.repository.name }}
          REPO_NAME_LOWER=$(echo "$REPO_NAME_LOWER" | tr '[:upper:]' '[:lower:]')

          echo "ğŸ“¦ Installing dependencies (make & jq)"
          sudo apt update && sudo apt install -y make jq || true

          echo "ğŸ“ Ensure project folder exists"
          mkdir -p ${{ secrets.SERVER_PROJECT_PATH }}
          cd ${{ secrets.SERVER_PROJECT_PATH }}

          echo "ğŸ§¹ Ensure .env exists"
          if [ ! -f ".env" ]; then
            make env || true
          fi

          echo "ğŸš€ Pulling latest image"
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/$REPO_NAME_LOWER:latest || true

          echo "â¬‡ï¸ Docker images after pull"
          docker images

          echo "ğŸ›‘ Stop old container"
          make clean || true

          echo "ğŸš€ Start new container using Docker Compose"
          make down || true
          make pull || true
          make build || true

          echo "ğŸ“¦ Running containers"
          docker ps -a

          echo "ğŸ“œ Tail logs (optional)"
          docker compose logs -f || true
